# ギタ log 基本設計書

## 1. システムアーキテクチャ

### 1.1 全体構成

```
[クライアント]
    ↓ (HTTPS)
[Vercel (Next.js)]
    ↓ (HTTPS)
[Railway/Supabase (NestJS)]
    ↓
[PostgreSQL]
```

### 1.2 ディレクトリ構成

```
/gita-log
├── apps
│   ├── web                 # フロントエンド (Next.js)
│   │   ├── src
│   │   │   ├── app        # ページコンポーネント
│   │   │   ├── components # 共通コンポーネント
│   │   │   ├── features   # 機能別コンポーネント
│   │   │   └── lib        # ユーティリティ
│   │   └── public         # 静的ファイル
│   │
│   └── api                # バックエンド (NestJS)
│       ├── src
│       │   ├── modules    # 機能モジュール
│       │   ├── common     # 共通モジュール
│       │   └── config     # 設定ファイル
│       └── test          # テストファイル
│
├── packages              # 共有パッケージ
│   ├── types            # 型定義
│   ├── validation       # バリデーション
│   └── utils            # ユーティリティ
│
└── prisma               # データベーススキーマ
```

## 2. データベース設計

### 2.1 ER 図

```prisma
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  logs      Log[]
}

model Log {
  id           String   @id @default(uuid())
  userId       String
  date         DateTime
  practiceTime Int      // 練習時間（分）
  song         String?  // 練習した曲
  skill        String?  // 練習したスキル
  comment      String?  // 感想・メモ
  audioUrl     String?  // 録音ファイルのURL
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
}
```

## 3. API 設計

### 3.1 認証 API

```
POST /api/auth/signup
POST /api/auth/login
POST /api/auth/logout
GET  /api/auth/me
```

### 3.2 練習ログ API

```
GET    /api/logs          # ログ一覧取得
POST   /api/logs          # 新規ログ作成
GET    /api/logs/:id      # 特定のログ取得
PUT    /api/logs/:id      # ログ更新
DELETE /api/logs/:id      # ログ削除
POST   /api/logs/upload   # 録音ファイルアップロード
```

## 4. フロントエンド設計

### 4.1 ページ構成

```
/                   # トップページ
/auth
  /login           # ログインページ
  /signup          # 新規登録ページ
/logs
  /                # ログ一覧ページ
  /new            # 新規ログ作成ページ
  /:id            # ログ詳細ページ
/profile           # プロフィールページ
```

### 4.2 主要コンポーネント

```
components/
├── auth/
│   ├── LoginForm.tsx
│   └── SignupForm.tsx
├── logs/
│   ├── LogForm.tsx
│   ├── LogList.tsx
│   └── LogCalendar.tsx
├── recorder/
│   ├── AudioRecorder.tsx
│   └── AudioPlayer.tsx
└── common/
    ├── Header.tsx
    ├── Footer.tsx
    └── Layout.tsx
```

## 5. セキュリティ設計

### 5.1 認証・認可

- JWT による認証
- パスワードのハッシュ化（bcrypt）
- CSRF 対策
- XSS 対策

### 5.2 データ保護

- 環境変数の適切な管理
- データベースの暗号化
- ファイルアップロードの制限

## 6. パフォーマンス設計

### 6.1 フロントエンド

- 画像の最適化
- コード分割
- キャッシュ戦略

### 6.2 バックエンド

- データベースインデックス
- クエリの最適化
- キャッシュの活用

## 7. エラーハンドリング

### 7.1 フロントエンド

- グローバルエラーバウンダリ
- フォームバリデーション
- エラーメッセージの表示

### 7.2 バックエンド

- 例外フィルター
- バリデーションパイプ
- エラーレスポンスの統一

## 8. テスト戦略

### 8.1 テスト種類

- ユニットテスト
- 統合テスト
- E2E テスト

### 8.2 テストツール

- Jest
- React Testing Library
- Cypress
